<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:HospitalManager.MVVM.ViewModels"
             x:Class="HospitalManager.MVVM.Views.DashboardPageView"
             Title="Dashboard"
             BackgroundColor="#F4F7FC">

    <ContentPage.BindingContext>
        <vm:DashboardViewModel />
    </ContentPage.BindingContext>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition x:Name="SideMenuColumn" Width="250" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0"
                Grid.Row="0"
                Grid.RowSpan="2" x:Name="SideMenu"
                BackgroundColor="White"
                Stroke="#E0E0E0"
                StrokeThickness="1"
                Padding="10">

            <VerticalStackLayout Spacing="10" Margin="5, 10, 5, 5">

                <Border x:Name="DashboardTab"
            Padding="10" 
            Margin="5,0"
            StrokeThickness="0"
            BackgroundColor="#FFFFFF">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnTabClicked" CommandParameter="Dashboard" />
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Tổng quan" TextColor="#1D2E4E" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Border>

                <Border x:Name="PatientsTab"
            Padding="10" 
            Margin="5,0"
            StrokeThickness="0"
            BackgroundColor="#FFFFFF">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnTabClicked" CommandParameter="Patients" />
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Bệnh nhân" TextColor="#1D2E4E" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Border>

                <Border x:Name="DoctorsTab"
            Padding="10" 
            Margin="5,0"
            StrokeThickness="0"
            BackgroundColor="#FFFFFF">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnTabClicked" CommandParameter="Doctors" />
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Bác sĩ" TextColor="#1D2E4E" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Border>

                <Border x:Name="AppointmentsTab"
            Padding="10" 
            Margin="5,0"
            StrokeThickness="0"
            BackgroundColor="#FFFFFF">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnTabClicked" CommandParameter="Appointments" />
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Lịch hẹn" TextColor="#1D2E4E" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Border>

            </VerticalStackLayout>
        </Border>


        <Grid Grid.Column="1"
              Grid.Row="0"
              Grid.RowSpan="2"
              RowDefinitions="Auto, *">
            <Grid Grid.Row="0"
                  Padding="20"
                  ColumnDefinitions="*, Auto, Auto, Auto" BackgroundColor="White">

                <Label Grid.Column="0"
                       x:Name="PageTitleLabel" Text="Tổng quan bệnh viện"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="#1D2E4E"
                       VerticalOptions="Center" />

                <Frame Grid.Column="1"
                       CornerRadius="8"
                       Padding="10"
                       Margin="0, 0, 15, 0"
                       BackgroundColor="#F4F7FC"
                       BorderColor="#E0E0E0"
                       HeightRequest="40"
                       VerticalOptions="Center">
                    <HorizontalStackLayout Spacing="10">
                        <Image Source="search.png" WidthRequest="20" HeightRequest="20" />
                        <Label Text="Tìm kiếm..." TextColor="#9E9E9E" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Frame>

                <Image Grid.Column="2"
                       Source="bell.png"
                       WidthRequest="24"
                       HeightRequest="24"
                       Margin="0, 0, 15, 0" />

                <HorizontalStackLayout Grid.Column="3" Spacing="10" VerticalOptions="Center">
                    <Label Text="{Binding UserName}"
                           TextColor="#1D2E4E"
                           VerticalOptions="Center" />
                    <Image Source="{Binding UserAvatar}"
                           WidthRequest="40"
                           HeightRequest="40"
                           Aspect="AspectFill">
                        <Image.Clip>
                            <EllipseGeometry Center="20, 20" RadiusX="20" RadiusY="20" />
                        </Image.Clip>
                    </Image>
                </HorizontalStackLayout>
            </Grid>

            <Grid Grid.Row="1" Padding="20">

                <ScrollView x:Name="DashboardContentView" IsVisible="True">
                    <VerticalStackLayout Spacing="25">

                        <CollectionView ItemsSource="{Binding SummaryCards}">
                            <CollectionView.ItemsLayout>
                                <GridItemsLayout Orientation="Vertical" Span="4" HorizontalItemSpacing="20" VerticalItemSpacing="20" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame BackgroundColor="White" CornerRadius="12" Padding="20" HasShadow="True" HeightRequest="150" BorderColor="#E0E0E0">
                                        <Grid RowDefinitions="Auto, *, Auto">
                                            <HorizontalStackLayout Grid.Row="0" Spacing="10">
                                                <Frame BackgroundColor="{Binding CardColor}" CornerRadius="8" WidthRequest="40" HeightRequest="40" Padding="8">
                                                </Frame>
                                                <Label Text="{Binding Title}" FontSize="16" FontAttributes="Bold" TextColor="#1D2E4E" VerticalOptions="Center" />
                                            </HorizontalStackLayout>
                                            <Label Grid.Row="1" Text="{Binding Value}" FontSize="36" FontAttributes="Bold" TextColor="#1D2E4E" VerticalOptions="Center" />
                                            <Label Grid.Row="2" Text="{Binding ChangePercentage}" FontSize="12" TextColor="#757575" />
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <Grid ColumnDefinitions="2*, 1*" ColumnSpacing="25">
                            <Frame Grid.Column="0" BackgroundColor="White" CornerRadius="12" Padding="20" HasShadow="True" HeightRequest="400" BorderColor="#E0E0E0">
                                <VerticalStackLayout Spacing="10">
                                    <Label Text="Biểu đồ trạng thái Lịch hẹn" FontSize="18" FontAttributes="Bold" TextColor="#1D2E4E" />
                                    <BoxView Color="#E0E0E0" HeightRequest="300" VerticalOptions="FillAndExpand" HorizontalOptions="FillAndExpand" />
                                    <Label Text="Chart Placeholder" HorizontalOptions="Center" TextColor="#9E9E9E" />
                                </VerticalStackLayout>
                            </Frame>

                            <Frame Grid.Column="1" BackgroundColor="White" CornerRadius="12" Padding="20" HasShadow="True" BorderColor="#E0E0E0">
                                <VerticalStackLayout Spacing="15">
                                    <Label Text="Hoạt động Gần đây" FontSize="18" FontAttributes="Bold" TextColor="#1D2E4E" />
                                    <CollectionView ItemsSource="{Binding RecentActivities}">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Grid Padding="0, 10" RowDefinitions="Auto, Auto">
                                                    <HorizontalStackLayout Grid.Row="0" Spacing="5">
                                                        <Label Text="•" TextColor="#4BC0C0" FontAttributes="Bold" />
                                                        <Label Text="{Binding Description}" TextColor="#1D2E4E" FontSize="14" HorizontalOptions="FillAndExpand" />
                                                        <Label Text="{Binding Time}" TextColor="#757575" FontSize="12" />
                                                    </HorizontalStackLayout>
                                                    <Label Grid.Row="1" Text="{Binding DoctorName}" TextColor="#9E9E9E" FontSize="12" Margin="15, 0, 0, 0" />
                                                </Grid>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </Frame>
                        </Grid>

                    </VerticalStackLayout>
                </ScrollView>

                <Grid x:Name="PatientsContentView" 
                      IsVisible="False" 
                      RowDefinitions="Auto, *">
                                    <HorizontalStackLayout Grid.Row="0" Margin="0, 0, 0, 15">
                                        <Button Text="+ Thêm Bệnh nhân"
                                        Command="{Binding ShowAddPatientPopupCommand}"
                                        BackgroundColor="#4CAF50"
                                        TextColor="White"
                                        CornerRadius="8"
                                        Padding="15, 10" />
                                    </HorizontalStackLayout>

                                    <Frame Grid.Row="1"
                           Padding="0"
                           CornerRadius="12"
                           BackgroundColor="White"
                           BorderColor="#E0E0E0"
                           HasShadow="True"
                           VerticalOptions="FillAndExpand">

                        <CollectionView ItemsSource="{Binding Patients}">
                            <CollectionView.Header>
                                <Grid Padding="15, 10" BackgroundColor="#F9FAFB" ColumnDefinitions="0.8*, 1.5*, 0.5*, 0.5*, 1.2*, 2*, 1*, 1*">
                                    <Label Grid.Column="0" Text="MÃ BN" FontAttributes="Bold" TextColor="#6B7280" />
                                    <Label Grid.Column="1" Text="HỌ TÊN" FontAttributes="Bold" TextColor="#6B7280" />
                                    <Label Grid.Column="2" Text="GIỚI" FontAttributes="Bold" TextColor="#6B7280" />
                                    <Label Grid.Column="3" Text="TUỔI" FontAttributes="Bold" TextColor="#6B7280" />
                                    <Label Grid.Column="4" Text="SĐT" FontAttributes="Bold" TextColor="#6B7280" />
                                    <Label Grid.Column="5" Text="ĐỊA CHỈ" FontAttributes="Bold" TextColor="#6B7280" />
                                    <Label Grid.Column="6" Text="TRẠNG THÁI" FontAttributes="Bold" TextColor="#6B7280" />
                                    <Label Grid.Column="7" Text="HÀNH ĐỘNG" FontAttributes="Bold" TextColor="#6B7280" />
                                </Grid>
                            </CollectionView.Header>

                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="15, 10" ColumnDefinitions="0.8*, 1.5*, 0.5*, 0.5*, 1.2*, 2*, 1*, 1*">
                                        <Border Grid.ColumnSpan="8" 
                                Stroke="#E0E0E0" 
                                StrokeThickness="1"
                                VerticalOptions="Start"
                                Margin="-15, -10, -15, 0"/>

                                        <Label Grid.Column="0" TextColor="#6B7280" Text="{Binding Id}" VerticalOptions="Center" />
                                        <Label Grid.Column="1" TextColor="#6B7280" Text="{Binding FullName}" FontAttributes="Bold" VerticalOptions="Center" />
                                        <Label Grid.Column="2" TextColor="#6B7280" Text="{Binding Gender}" VerticalOptions="Center" />
                                        <Label Grid.Column="3" TextColor="#6B7280" Text="{Binding Age}" VerticalOptions="Center" />
                                        <Label Grid.Column="4" TextColor="#6B7280" Text="{Binding PhoneNumber}" VerticalOptions="Center" />
                                        <Label Grid.Column="5" TextColor="#6B7280" Text="{Binding Address}" VerticalOptions="Center" LineBreakMode="TailTruncation" />

                                        <Frame Grid.Column="6" 
                                           Padding="8, 4" 
                                           CornerRadius="8"
                                           HorizontalOptions="Start"
                                           VerticalOptions="Center"
                                           BorderColor="Transparent"
                                           BackgroundColor="Transparent">
                                            <Label Text="{Binding Status}" 
                                               TextColor= "#6B7280"
                                               FontSize="12"
                                               FontAttributes="Bold"/>
                                        </Frame>

                                        <HorizontalStackLayout Grid.Column="7" Spacing="10" VerticalOptions="Center">
                                            <ImageButton Source="edit.png" 
                                                 WidthRequest="18" 
                                                 HeightRequest="18"
                                                 Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=ShowEditPatientPopupCommand}"
                                                 CommandParameter="{Binding .}"/>
                                            <ImageButton Source="delete.png" 
                                                 WidthRequest="18" 
                                                 HeightRequest="18"
                                                 Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=DeletePatientCommand}"
                                                 CommandParameter="{Binding .}" />
                                        </HorizontalStackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Frame>
                </Grid>

                <VerticalStackLayout x:Name="DoctorsContentView" IsVisible="False">
                    <Label Text="Trang Quản lý Bác sĩ" FontSize="24" FontAttributes="Bold" TextColor="#1D2E4E" />
                    <Label Text="Nội dung quản lý bác sĩ sẽ ở đây..." />
                </VerticalStackLayout>

                <VerticalStackLayout x:Name="AppointmentsContentView" IsVisible="False">
                    <Label Text="Trang Quản lý Lịch hẹn" FontSize="24" FontAttributes="Bold" TextColor="#1D2E4E" />
                    <Label Text="Nội dung quản lý lịch hẹn sẽ ở đây..." />
                </VerticalStackLayout>

            </Grid>
        </Grid>
        <Grid Grid.Column="0"
              Grid.ColumnSpan="2" Grid.RowSpan="2" IsVisible="{Binding IsAddPatientPopupVisible}"
              BackgroundColor="#80000000">
            <Border Padding="20"
                    Margin="0"
                    BackgroundColor="White"
                    StrokeThickness="0"
                    VerticalOptions="Center"
                    HorizontalOptions="Center"
                    WidthRequest="600"
                    StrokeShape="RoundRectangle 12">
                <VerticalStackLayout Spacing="15">
                    <Label Text="{Binding PopupTitle}" FontSize="24" FontAttributes="Bold" TextColor="#1D2E4E" HorizontalOptions="Center" />

                    <Grid ColumnDefinitions="Auto, *" RowDefinitions="Auto, Auto, Auto, Auto, Auto, Auto" RowSpacing="10" ColumnSpacing="10">

                        <Label Grid.Row="0" Grid.Column="0" Text="Họ tên:" VerticalOptions="Center" TextColor="#1D2E4E" />
                        <Entry Grid.Row="0" Grid.Column="1" Text="{Binding NewPatientFullName}" Placeholder="Nguyễn Văn An" TextColor="#1D2E4E" />

                        <Label Grid.Row="1" Grid.Column="0" Text="Ngày sinh:" VerticalOptions="Center" TextColor="#1D2E4E" />
                        <DatePicker Grid.Row="1" Grid.Column="1" Date="{Binding NewPatientDateOfBirth}" TextColor="#1D2E4E" />

                        <Label Grid.Row="2" Grid.Column="0" Text="Giới tính:" VerticalOptions="Center" TextColor="#1D2E4E" />
                        <Picker Grid.Row="2" Grid.Column="1" ItemsSource="{Binding Genders}" SelectedItem="{Binding NewPatientGender}" TextColor="#1D2E4E" />

                        <Label Grid.Row="3" Grid.Column="0" Text="SĐT:" VerticalOptions="Center" TextColor="#1D2E4E" />
                        <Entry Grid.Row="3" Grid.Column="1" Text="{Binding NewPatientPhoneNumber}" Placeholder="0901234567" Keyboard="Telephone" TextColor="#1D2E4E" />

                        <Label Grid.Row="4" Grid.Column="0" Text="Địa chỉ:" VerticalOptions="Center" TextColor="#1D2E4E"/>
                        <Entry Grid.Row="4" Grid.Column="1" Text="{Binding NewPatientAddress}" Placeholder="123 Đường ABC..." TextColor="#1D2E4E" />

                        <Label Grid.Row="5" Grid.Column="0" Text="Trạng thái:" VerticalOptions="Center" TextColor="#1D2E4E" />
                        <Picker Grid.Row="5" Grid.Column="1" ItemsSource="{Binding StatusOptions}" SelectedItem="{Binding NewPatientStatus}" TextColor="#1D2E4E" />
                    </Grid>

                    <HorizontalStackLayout Spacing="10" HorizontalOptions="End" Margin="0, 20, 0, 0">
                        <Button Text="Hủy"
                                Command="{Binding CloseAddPatientPopupCommand}"
                                BackgroundColor="#E0E0E0"
                                TextColor="#333333" />
                        <Button Text="Lưu"
                                Command="{Binding SavePatientCommand}"
                                BackgroundColor="#4CAF50"
                                TextColor="White" />
                    </HorizontalStackLayout>

                </VerticalStackLayout>
            </Border>
        </Grid>
    </Grid>
</ContentPage>