<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:HosipitalManager.MVVM.ViewModels"
             xmlns:models="clr-namespace:HosipitalManager.MVVM.Models"
             x:Class="HosipitalManager.MVVM.Views.AppointmentPageView"
             x:Name="ThisPage">

    <Grid Padding="20" RowDefinitions="Auto, Auto, Auto, *">

        <Grid Grid.Row="0" ColumnDefinitions="*,*,*,*" Margin="0,0,0,20">
    
    <VerticalStackLayout Grid.Column="0">
        <VerticalStackLayout.GestureRecognizers>
            <TapGestureRecognizer Command="{Binding SwitchTabCommand}" CommandParameter="Upcoming"/>
        </VerticalStackLayout.GestureRecognizers>
        
        <Label Text="Sắp tới" HorizontalOptions="Center" FontSize="16" FontAttributes="Bold">
            <Label.Triggers>
                <DataTrigger TargetType="Label" 
                             Binding="{Binding CurrentTab, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=Upcoming}" 
                             Value="True">
                    <Setter Property="TextColor" Value="#1D2E4E" />
                </DataTrigger>
                <DataTrigger TargetType="Label" 
                             Binding="{Binding CurrentTab, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=Upcoming}" 
                             Value="False">
                    <Setter Property="TextColor" Value="Gray" />
                </DataTrigger>
            </Label.Triggers>
        </Label>
        
        <BoxView HeightRequest="3" Color="#6B4FA1" 
                 IsVisible="{Binding CurrentTab, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=Upcoming}"/>
    </VerticalStackLayout>

    <VerticalStackLayout Grid.Column="1">
        <VerticalStackLayout.GestureRecognizers>
            <TapGestureRecognizer Command="{Binding SwitchTabCommand}" CommandParameter="Pending"/>
        </VerticalStackLayout.GestureRecognizers>

        <Label Text="Chờ xác nhận" HorizontalOptions="Center" FontSize="16" FontAttributes="Bold">
            <Label.Triggers>
                <DataTrigger TargetType="Label" 
                             Binding="{Binding CurrentTab, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=Pending}" 
                             Value="True">
                    <Setter Property="TextColor" Value="#1D2E4E" />
                </DataTrigger>
                <DataTrigger TargetType="Label" 
                             Binding="{Binding CurrentTab, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=Pending}" 
                             Value="False">
                    <Setter Property="TextColor" Value="Gray" />
                </DataTrigger>
            </Label.Triggers>
        </Label>

        <BoxView HeightRequest="3" Color="#6B4FA1" 
                 IsVisible="{Binding CurrentTab, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=Pending}"/>
    </VerticalStackLayout>

    <VerticalStackLayout Grid.Column="2">
        <VerticalStackLayout.GestureRecognizers>
            <TapGestureRecognizer Command="{Binding SwitchTabCommand}" CommandParameter="Completed"/>
        </VerticalStackLayout.GestureRecognizers>
        <Label Text="Đã hoàn thành" HorizontalOptions="Center" FontSize="14" FontAttributes="Bold">
            <Label.Triggers>
                <DataTrigger TargetType="Label" Binding="{Binding CurrentTab, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=Completed}" Value="True">
                    <Setter Property="TextColor" Value="#1D2E4E" />
                </DataTrigger>
                <DataTrigger TargetType="Label" Binding="{Binding CurrentTab, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=Completed}" Value="False">
                    <Setter Property="TextColor" Value="Gray" />
                </DataTrigger>
            </Label.Triggers>
        </Label>
        <BoxView HeightRequest="3" Color="#6B4FA1" IsVisible="{Binding CurrentTab, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=Completed}"/>
    </VerticalStackLayout>

        </Grid>
        <Grid Grid.Row="1" ColumnDefinitions="*, Auto" ColumnSpacing="10" Margin="0,0,0,20">
            <Border Grid.Column="0" Stroke="#E0E0E0" StrokeShape="RoundRectangle 8">
                <Grid ColumnDefinitions="Auto, *"
                      BackgroundColor="White">
                    <Image Source="search.png" WidthRequest="18" HeightRequest="18"  Margin="5,0,5,0"/>
                    <Entry Grid.Column="1" Placeholder="Tìm tên BS hoặc Bệnh nhân..." 
                           Text="{Binding SearchText}"
                           ReturnCommand="{Binding PerformSearchCommand}"
                           TextColor="#1D2E4E"
                           BackgroundColor="White"/>
                </Grid>
            </Border>

            <Button Grid.Column="1"
                    Text="+" FontSize="30"
                    WidthRequest="50" HeightRequest="50" CornerRadius="25"
                    BackgroundColor="{StaticResource ColorPrimary}"
                    TextColor="White"
                    Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.NavigateToAddCommand}" />  
        </Grid>

        <Grid Grid.Row="2" ColumnDefinitions="*,*,*,*" ColumnSpacing="10" Margin="0,0,0,20">
            <Frame Grid.Column="0" Padding="10">
                <VerticalStackLayout>
                    <Label Text="Sắp tới" FontSize="12" TextColor="Gray"/>
                    <Label Text="{Binding UpcomingCount}" FontSize="20" FontAttributes="Bold" TextColor="#4CAF50"/>
                </VerticalStackLayout>
            </Frame>
        </Grid>

        <CollectionView Grid.Row="3" ItemsSource="{Binding FilteredAppointments}">
            <CollectionView.EmptyView>
                <Label Text="Không có lịch hẹn nào." HorizontalOptions="Center" VerticalOptions="Center" TextColor="Gray"/>
            </CollectionView.EmptyView>
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame Margin="0,0,0,15" 
               Padding="15" 
               CornerRadius="12" 
               HasShadow="True" 
               BorderColor="#E0E0E0"
               BackgroundColor="White">

                        <Grid ColumnDefinitions="Auto, *, Auto" ColumnSpacing="15">

                            <Border Grid.Column="0" 
                        WidthRequest="70" 
                        HeightRequest="70" 
                        StrokeShape="RoundRectangle 10"
                        VerticalOptions="Start">
                                <Image Source="{Binding Doctor.ImageSource}" 
                           Aspect="AspectFill"
                           WidthRequest="70" 
                           HeightRequest="70"/>
                            </Border>

                            <VerticalStackLayout Grid.Column="1" Spacing="6" VerticalOptions="Center">

                                <Label FontSize="15" FontAttributes="Bold" LineBreakMode="TailTruncation">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="BS. " TextColor="#5B9FFF"/>
                                            <Span Text="{Binding Doctor.Name}" TextColor="#1D2E4E"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>

                                <HorizontalStackLayout Spacing="8">
                                    <Image Source="calendaricon.png" WidthRequest="14" HeightRequest="14" VerticalOptions="Center"/>
                                    <Label Text="{Binding AppointmentDate, StringFormat='{0:dd/MM/yyyy}'}" 
                               FontSize="13" 
                               TextColor="#757575" 
                               VerticalOptions="Center"/>
                                </HorizontalStackLayout>

                                <HorizontalStackLayout Spacing="8">
                                    <Image Source="clock.png" WidthRequest="14" HeightRequest="14" VerticalOptions="Center">
                                    </Image>
                                    <Label FontSize="13" TextColor="#1D2E4E" VerticalOptions="Center" FontAttributes="Bold">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="{Binding StartTime, StringFormat='{0:hh\\:mm}'}"/>
                                                <Span Text=" - "/>
                                                <Span Text="{Binding EndTime, StringFormat='{0:hh\\:mm}'}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </HorizontalStackLayout>

                                <HorizontalStackLayout Spacing="8">
                                    <Image WidthRequest="14" HeightRequest="14" VerticalOptions="Center">
                                        <Image.Source>
                                            <FontImageSource FontFamily="FontAwesomeSolid" Glyph="&#xf007;" Color="#757575" Size="14"/>
                                        </Image.Source>
                                    </Image>
                                    <Label Text="{Binding PatientName}" 
                               FontSize="13" 
                               TextColor="#757575" 
                               LineBreakMode="TailTruncation"
                               VerticalOptions="Center"/>
                                </HorizontalStackLayout>
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Column="2" Spacing="10" VerticalOptions="Center">

                                <Button Text="Duyệt"
                                    FontSize="12"
                                    Padding="10,0"
                                    HeightRequest="35"
                                    BackgroundColor="{StaticResource ColorPrimary}"
                                    TextColor="White"
                                    CornerRadius="5"
                                    Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.ConfirmAppointmentCommand}"
                                    CommandParameter="{Binding .}">
                                    <Button.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding Status}" Value="Pending">
                                            <Setter Property="IsVisible" Value="True"/>
                                        </DataTrigger>
                                        <DataTrigger TargetType="Button" Binding="{Binding Status}" Value="Upcoming">
                                            <Setter Property="IsVisible" Value="False"/>
                                        </DataTrigger>
                                        <DataTrigger TargetType="Button" Binding="{Binding Status}" Value="Cancelled">
                                            <Setter Property="IsVisible" Value="False"/>
                                        </DataTrigger>
                                        <DataTrigger TargetType="Button" Binding="{Binding Status}" Value="Completed">
                                            <Setter Property="IsVisible" Value="False"/>
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button Text="Hủy"
                                    FontSize="12"
                                    Padding="10,0"
                                    HeightRequest="36"
                                    BackgroundColor="#757575"
                                    TextColor="White"
                                    CornerRadius="6"
                                    Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.CancelAppointmentCommand}"
                                    CommandParameter="{Binding .}">
                                    <Button.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding Status}" Value="Cancelled">
                                            <Setter Property="IsVisible" Value="False"/>
                                        </DataTrigger>
                                        <DataTrigger TargetType="Button" Binding="{Binding Status}" Value="Completed">
                                            <Setter Property="IsVisible" Value="False"/>
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Label Text="{Binding Status}" 
                           FontSize="10" 
                           TextColor="Gray" 
                           HorizontalOptions="Center"/>

                            </VerticalStackLayout>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

    </Grid>
</ContentView>